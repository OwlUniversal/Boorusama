name: Build and Release Android APK

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Force Upgrade fvp (Quietly)
        # Filters out the "Found plugin" spam so logs are readable
        run: |
          sed -i 's/fvp:.*/fvp:/' pubspec.yaml
          flutter pub upgrade fvp --major-versions | grep -v "Found plugin" || true
          flutter pub get | grep -v "Found plugin" || true

      - name: Make scripts executable
        run: chmod +x gen.sh build.sh

      - name: Create Dummy Configs
        run: |
          echo "REVENUECAT_GOOGLE_API_KEY=dummy" > .env
          echo "REVENUECAT_APPLE_API_KEY=dummy" >> .env
          mkdir -p env
          echo '{"api_url": "dummy"}' > env/prod.json
          
          mkdir -p android/app/src/prod
          echo '{
            "project_info": { "project_number": "1", "project_id": "dummy", "storage_bucket": "d" },
            "client": [
              {
                "client_info": { "mobilesdk_app_id": "1:1:android:1", "android_client_info": { "package_name": "com.khoadng.boorusama" } },
                "api_key": [{ "current_key": "d" }],
                "services": { "appinvite_service": { "status": 1 } }
              }
            ],
            "configuration_version": "1"
          }' > android/app/src/prod/google-services.json

      - name: Run code generation
        # Also quiet this step
        run: ./gen.sh --delete-conflicting-outputs | grep -v "Found plugin" || true

      - name: Build Production APK
        run: ./build.sh apk --flavor prod

      - name: Upload Artifact (Manual Run)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: Boorusama-Plus-APK
          path: build/app/outputs/flutter-apk/app-prod-*.apk

      - name: Create Release and Upload
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: build/app/outputs/flutter-apk/app-prod-*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
